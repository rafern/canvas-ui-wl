var ft=Object.defineProperty;var at=Object.getOwnPropertySymbols;var wt=Object.prototype.hasOwnProperty,yt=Object.prototype.propertyIsEnumerable;var _t=(_,t,e)=>t in _?ft(_,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):_[t]=e,lt=(_,t)=>{for(var e in t||(t={}))wt.call(t,e)&&_t(_,e,t[e]);if(at)for(var e of at(t))yt.call(t,e)&&_t(_,e,t[e]);return _};import{Root as Lt,PointerDriver as Ft,DOMKeyboardDriver as Tt}from"@rafern/canvas-ui";var ct={},ht=[],xt=["_id","_manager","type","_type","active"];function R(_,t,e){_WL.registerComponent(_,t,e)}var v={Bool:1<<1,Int:1<<2,Float:1<<3,String:1<<4,Enum:1<<5,Object:1<<6,Mesh:1<<7,Texture:1<<8,Material:1<<9,Animation:1<<10,Skin:1<<11};var pt={Sphere:0,AxisAlignedBox:1,Box:2};var W={Head:0,EyeLeft:1,EyeRight:2,ControllerLeft:3,ControllerRight:4,RayLeft:5,RayRight:6};var dt={Force:0,Impulse:1,VelocityChange:2,Acceleration:3};var S={None:0,Sphere:1,Capsule:2,Box:3,Plane:4,ConvexMesh:5,TriangleMesh:6};var I=null,ut=null;var bt,U,E=[];var a=null,b=0,i=null,z=null,L=null,M=null,gt=null;function jt(_){console.log("Allocating temp mem:",_),b=_,a&&_free(a),a=_malloc(b),vt()}function mt(_){b>=_||jt(Math.ceil(_/1024)*1024)}function vt(){i=new Float32Array(HEAP8.buffer,a,b>>2),z=new Int32Array(HEAP8.buffer,a,b>>2),L=new Uint32Array(HEAP8.buffer,a,b>>2),M=new Uint16Array(HEAP8.buffer,a,b>>1),gt=new Uint8Array(HEAP8.buffer,a,b)}var g=class{constructor(t,e){this._id=e,this._manager=t}get type(){return this._type||d._typeNameFor(this._manager)}get object(){let t=_wl_component_get_object(this._manager,this._id);return d._wrapObject(t)}set active(t){_wl_component_setActive(this._manager,this._id,t)}get active(){return _wl_component_isActive(this._manager,this._id)!=0}destroy(){_wl_component_remove(this._manager,this._id),this._manager=void 0,this._id=void 0}equals(t){return t?this._manager==t._manager&&this._id==t._id:!1}};var O=class extends g{get collider(){return _wl_collision_component_get_collider(this._id)}set collider(t){_wl_collision_component_set_collider(this._id,t)}get extents(){return new Float32Array(HEAPF32.buffer,_wl_collision_component_get_extents(this._id),3)}set extents(t){this.extents.set(t)}get group(){return _wl_collision_component_get_group(this._id)}set group(t){_wl_collision_component_set_group(this._id,t)}queryOverlaps(){let t=_wl_collision_component_query_overlaps(this._id,a,b>>1),e=new Array(t);for(let n=0;n<t;++n)e[n]=new O(this._manager,M[n]);return e}};var Z=class extends g{get alignment(){return _wl_text_component_get_horizontal_alignment(this._id)}set alignment(t){_wl_text_component_set_horizontal_alignment(this._id,t)}get justification(){return _wl_text_component_get_vertical_alignment(this._id)}set justification(t){_wl_text_component_set_vertical_alignment(this._id,t)}get characterSpacing(){return _wl_text_component_get_character_spacing(this._id)}set characterSpacing(t){_wl_text_component_set_character_spacing(this._id,t)}get lineSpacing(){return _wl_text_component_get_line_spacing(this._id)}set lineSpacing(t){_wl_text_component_set_line_spacing(this._id,t)}get effect(){return _wl_text_component_get_effect(this._id)}set effect(t){_wl_text_component_set_effect(this._id,t)}get text(){return UTF8ToString(_wl_text_component_get_text(this._id))}set text(t){let e=lengthBytesUTF8(t)+1,n=_malloc(e);stringToUTF8(t,n,e),_wl_text_component_set_text(this._id,n),_free(n)}set material(t){_wl_text_component_set_material(this._id,t?t._index:0)}get material(){return F.wrap(_wl_text_component_get_material(this._id))}};var G=class extends g{get projectionMatrix(){return new Float32Array(HEAPF32.buffer,_wl_view_component_get_projection_matrix(this._id),16)}get near(){return _wl_view_component_get_near(this._id)}set near(t){this.active&&WL.xrSession&&(WL.xrSession.depthNear=t),_wl_view_component_set_near(this._id,t)}get far(){return _wl_view_component_get_far(this._id)}set far(t){this.active&&WL.xrSession&&(WL.xrSession.depthFar=t),_wl_view_component_set_far(this._id,t)}};var J=class extends g{get inputType(){return _wl_input_component_get_type(this._id)}set inputType(t){_wl_input_component_set_type(this._id,t)}get xrInputSource(){if(ut){for(let t of ut.inputSources)if(t.handedness==this.handedness)return t}return null}get handedness(){let t=this.inputType;return t==W.ControllerRight||t==W.RayRight||t==W.EyeRight?"right":t==W.ControllerLeft||t==W.RayLeft||t==W.EyeLeft?"left":null}};var Y=class extends g{get color(){return new Float32Array(HEAPF32.buffer,_wl_light_component_get_color(this._id),4)}get lightType(){return _wl_light_component_get_type(this._id)}set lightType(t){return _wl_light_component_set_type(this._id,t)}};var Q=class extends g{set animation(t){_wl_animation_component_set_animation(this._id,t._index)}get animation(){return new k(_wl_animation_component_get_animation(this._id))}set playCount(t){_wl_animation_component_set_playCount(this._id,t)}get playCount(){return _wl_animation_component_get_playCount(this._id)}set speed(t){_wl_animation_component_set_speed(this._id,t)}get speed(){return _wl_animation_component_get_speed(this._id)}play(){_wl_animation_component_play(this._id)}stop(){_wl_animation_component_stop(this._id)}pause(){_wl_animation_component_pause(this._id)}get state(){return _wl_animation_component_state(this._id)}};var q=class extends g{set material(t){_wl_mesh_component_set_material(this._id,t?t._index:0)}get material(){return F.wrap(_wl_mesh_component_get_material(this._id))}get mesh(){return new x(_wl_mesh_component_get_mesh(this._id))}set mesh(t){_wl_mesh_component_set_mesh(this._id,t._index)}get skin(){return new V(_wl_mesh_component_get_skin(this._id))}set skin(t){_wl_mesh_component_set_skin(this._id,t._index)}};var H=class extends g{set static(t){_wl_physx_component_set_static(this._id,t)}get static(){return!!_wl_physx_component_get_static(this._id)}set kinematic(t){_wl_physx_component_set_kinematic(this._id,t)}get kinematic(){return!!_wl_physx_component_get_kinematic(this._id)}set shape(t){_wl_physx_component_set_shape(this._id,t)}get shape(){return _wl_physx_component_get_shape(this._id)}set shapeData(t){t==null||![S.TriangleMesh,S.ConvexMesh].includes(this.shape)||_wl_physx_component_set_shape_data(this._id,t.index)}get shapeData(){return[S.TriangleMesh,S.ConvexMesh].includes(this.shape)?{index:_wl_physx_component_get_shape_data(this._id)}:null}set extents(t){this.extents.set(t)}get extents(){let t=_wl_physx_component_get_extents(this._id);return new Float32Array(HEAPF32.buffer,t,3)}get staticFriction(){return _wl_physx_component_get_staticFriction(this._id)}set staticFriction(t){_wl_physx_component_set_staticFriction(this._id,t)}get dynamicFriction(){return _wl_physx_component_get_dynamicFriction(this._id)}set dynamicFriction(t){_wl_physx_component_set_dynamicFriction(this._id,t)}get bounciness(){return _wl_physx_component_get_bounciness(this._id)}set bounciness(t){_wl_physx_component_set_bounciness(this._id,t)}get linearDamping(){return _wl_physx_component_get_linearDamping(this._id)}set linearDamping(t){_wl_physx_component_set_linearDamping(this._id,t)}get angularDamping(){return _wl_physx_component_get_angularDamping(this._id)}set angularDamping(t){_wl_physx_component_set_angularDamping(this._id,t)}set linearVelocity(t){_wl_physx_component_set_linearVelocity(this._id,t[0],t[1],t[2])}get linearVelocity(){return _wl_physx_component_get_linearVelocity(this._id,a),new Float32Array(HEAPF32.buffer,a,3)}set angularVelocity(t){_wl_physx_component_set_angularVelocity(this._id,t[0],t[1],t[2])}get angularVelocity(){return _wl_physx_component_get_angularVelocity(this._id,a),new Float32Array(HEAPF32.buffer,a,3)}set mass(t){_wl_physx_component_set_mass(this._id,t)}get mass(){return _wl_physx_component_get_mass(this._id)}set massSpaceInteriaTensor(t){_wl_physx_component_set_massSpaceInertiaTensor(this._id,t[0],t[1],t[2])}addForce(t,e,n,r,o){e=e||dt.Force,r?_wl_physx_component_addForceAt(this._id,t[0],t[1],t[2],e,!!n,r[0],r[1],r[2],!!o):_wl_physx_component_addForce(this._id,t[0],t[1],t[2],e,!!n)}addTorque(t,e){e=e||dt.Force,_wl_physx_component_addTorque(this._id,t[0],t[1],t[2],e)}onCollision(t){return this.onCollisionWith(this,t)}onCollisionWith(t,e){return U._callbacks[this._id]=U._callbacks[this._id]||[],U._callbacks[this._id].push(e),_wl_physx_component_addCallback(this._id,t._id||this._id)}removeCollisionCallback(t){let e=_wl_physx_component_removeCallback(this._id,t);e&&U._callbacks[this._id].splice(-e)}};for(let _ of["static","extents","staticFriction","dynamicFriction","bounciness","linearDamping","angularDamping","shape","shapeData","kinematic","linearVelocity","angularVelocity","mass"])Object.defineProperty(H.prototype,_,{enumerable:!0});var x=class{static get VERTEX_FLOAT_SIZE(){return 3+3+2}static get VERTEX_SIZE(){return this.VERTEX_FLOAT_SIZE*4}static get POS(){return{X:0,Y:1,Z:2}}static get TEXCOORD(){return{U:3,V:4}}static get NORMAL(){return{X:5,Y:6,Z:7}}constructor(t){if(typeof t=="object"){if(!t.vertexCount&&t.vertexData&&(t.vertexCount=t.vertexData.length/WL.Mesh.VERTEX_FLOAT_SIZE),!t.vertexCount)throw new Error("Missing parameter 'vertexCount'");let e=null,n=0;if(t.indexData){let r=t.indexType||WL.MeshIndexType.UnsignedShort;switch(n=t.indexData.length*r,e=_malloc(n),r){case j.UnsignedByte:HEAPU8.set(t.indexData,e);break;case j.UnsignedShort:HEAPU16.set(t.indexData,e>>1);break;case j.UnsignedInt:HEAPU32.set(t.indexData,e>>2);break}}if(this._index=_wl_mesh_create(e,n,t.indexType,t.vertexCount),t.vertexData){let r=this.attribute(WL.MeshAttribute.Position),o=this.attribute(WL.MeshAttribute.Normal),s=this.attribute(WL.MeshAttribute.TextureCoordinate);for(let l=0;l<t.vertexCount;++l){let c=l*WL.Mesh.VERTEX_FLOAT_SIZE;r.set(l,t.vertexData.subarray(c,c+3)),s.set(l,t.vertexData.subarray(c+3,c+5)),o.set(l,t.vertexData.subarray(c+5,c+8))}}}else this._index=t}get vertexData(){let t=_wl_mesh_get_vertexData(this._index,a);return new Float32Array(HEAPF32.buffer,t,WL.Mesh.VERTEX_FLOAT_SIZE*HEAPU32[a/4])}get vertexCount(){return _wl_mesh_get_vertexCount(this._index)}get indexData(){let t=_wl_mesh_get_indexData(this._index,a,a+4);if(t===null)return null;let e=HEAPU32[a/4];switch(HEAPU32[a/4+1]){case j.UnsignedByte:return new Uint8Array(HEAPU8.buffer,t,e);case j.UnsignedShort:return new Uint16Array(HEAPU16.buffer,t,e);case j.UnsignedInt:return new Uint32Array(HEAPU32.buffer,t,e)}}attribute(t){if(typeof t!="number")throw new TypeError("Expected number, but got "+typeof t);return new $(this._index,t,this.vertexCount)}destroy(){_wl_mesh_destroy(this._index)}};var $=class{constructor(t,e,n){_wl_mesh_get_attribute(t,e,a),this._attribute=L[0],this._offset=L[1],this._stride=L[2],this._formatSize=L[3],this._componentCount=L[4],this.length=n}get(t,e){let n=this._componentCount;e=e||new Float32Array(n),mt(4*e.length);let r=i.subarray(0,e.length);_wl_mesh_get_attribute_values(this._attribute,this._offset+t*this._stride,this._stride,1,this._formatSize,this._componentCount,r.byteOffset,r.byteLength);for(let o=0;o<e.length;++o)e[o]=r[o];return e}set(t,e){if(e.length%this._componentCount!=0)throw new Error("v.length, "+e.length+", is not a multiple of the attribute vector components, "+this._componentCount);if(e.buffer!=HEAPU8.buffer){mt(4*e.length);let n=i.subarray(0,e.length);n.set(e),e=n}_wl_mesh_set_attribute_values(this._attribute,this._offset+t*this._stride,this._stride,e.length/this._componentCount,this._formatSize,this._componentCount,e.byteOffset,e.byteLength)}};var j={UnsignedByte:1,UnsignedShort:2,UnsignedInt:4};var F=class{constructor(t){this._index=t}get shader(){return UTF8ToString(_wl_material_get_shader(this._index))}clone(){return F.wrap(_wl_material_clone(this._index))}_paramIndex(t){let e=lengthBytesUTF8(t)+1,n=_malloc(e);stringToUTF8(t,n,e);let r=_wl_material_get_param_index(this._index,n);return _free(n),r}_paramType(t){let e=_wl_material_get_param_type(this._index,t);return{type:e&255,componentCount:e>>8&255,metaType:e>>16&255}}static wrap(t){if(t<=0)return null;let e=new F(t);return new Proxy(e,{get(n,r){let o=n._paramIndex(r);if(o!=-1){let s=n._paramType(o);if(_wl_material_get_param_value(n._index,o,a)){if(s.type==0)return s.componentCount==1?L[0]:new Uint32Array(HEAPF32.buffer,a,s.componentCount);if(s.type==1)return s.componentCount==1?z[0]:new Int32Array(HEAPF32.buffer,a,s.componentCount);if(s.type==2)return s.componentCount==1?i[0]:new Float32Array(HEAPF32.buffer,a,s.componentCount);if(s.type==3)return new T(z[0])}throw new Error(`Invalid type ${s} on parameter ${o} for material ${n._index}`)}else return n[r]},set(n,r,o){let s=n._paramIndex(r);if(s>=0)if(o instanceof T)_wl_material_set_param_value_uint(n._index,s,o._id);else if(typeof o=="number")i[0]=o,_wl_material_set_param_value_float(n._index,s,a,1);else{let l=o.length;for(let c=0;c<l;++c)i[c]=o[c];_wl_material_set_param_value_float(n._index,s,a,l)}else n[r]=o;return!0}})}};var A=null,T=class{constructor(t){if(t instanceof HTMLImageElement||t instanceof HTMLVideoElement||t instanceof HTMLCanvasElement){let e=E.length;E.push(t),this._imageIndex=e,this._id=_wl_renderer_addImage(e)}else this._id=t;Ct[this._id]=this}get valid(){return this._id>=0}update(){!this.valid||_wl_renderer_updateImage(this._id,this._imageIndex)}updateSubImage(t,e,n,r){if(!this.valid)return;A||(A=document.createElement("canvas"));let o=E[this._imageIndex];A.width=n,A.height=r,A.getContext("2d").drawImage(o,t,e,n,r,0,0,n,r),E[this._imageIndex]=A;try{_wl_renderer_updateImage(this._id,this._imageIndex,t,(o.videoHeight||o.height)-e-r)}finally{E[this._imageIndex]=o}}destroy(){_wl_texture_destroy(this._id),this._imageIndex&&(E[this._imageIndex]=null,this._imageIndex=void 0)}};var Ct={load:function(_,t){let e=new Image;return t!==void 0&&(e.crossOrigin=t),e.src=_,new Promise((n,r)=>{e.onload=function(){let o=new T(e);o.valid||r("Failed to add image "+e.src+" to texture atlas. Probably incompatible format."),n(o)}})}},k=class{constructor(t){this._index=t}get duration(){return _wl_animation_get_duration(this._index)}get trackCount(){return _wl_animation_get_trackCount(this._index)}retarget(t){if(t instanceof V){let r=_wl_animation_retargetToSkin(this._index,t._index);return new k(r)}if(t.length!=this.trackCount)throw Error("Expected "+this.trackCount.toString()+" targets, but got "+t.length.toString());let e=_malloc(2*t.length);for(let r=0;r<t.length;++r)HEAPU16[e>>1+r]=t[r].objectId;let n=_wl_animation_retarget(this._index,e);return _free(e),new k(n)}};var d=class{constructor(t){this.objectId=t}get name(){return UTF8ToString(_wl_object_name(this.objectId))}set name(t){let e=lengthBytesUTF8(t)+1,n=_malloc(e);stringToUTF8(t,n,e),_wl_object_set_name(this.objectId,n),_free(n)}get parent(){let t=_wl_object_parent(this.objectId);return t==0?null:d._wrapObject(t)}get children(){let t=_wl_object_get_children(this.objectId,a,b>>1);if(t==0)return[];let e=new Array(t);for(let n=0;n<t;++n)e[n]=d._wrapObject(M[n]);return e}set parent(t){_wl_object_set_parent(this.objectId,t==null?0:t.objectId)}resetTransform(){_wl_object_reset_translation_rotation(this.objectId),_wl_object_reset_scaling(this.objectId)}resetTranslationRotation(){_wl_object_reset_translation_rotation(this.objectId)}resetRotation(){_wl_object_reset_rotation(this.objectId)}resetTranslation(){_wl_object_reset_translation(this.objectId)}resetScaling(){_wl_object_reset_scaling(this.objectId)}translate(t){_wl_object_translate(this.objectId,t[0],t[1],t[2])}translateObject(t){_wl_object_translate_obj(this.objectId,t[0],t[1],t[2])}translateWorld(t){_wl_object_translate_world(this.objectId,t[0],t[1],t[2])}rotateAxisAngleDeg(t,e){_wl_object_rotate_axis_angle(this.objectId,t[0],t[1],t[2],e)}rotateAxisAngleRad(t,e){_wl_object_rotate_axis_angle_rad(this.objectId,t[0],t[1],t[2],e)}rotateAxisAngleDegObject(t,e){_wl_object_rotate_axis_angle_obj(this.objectId,t[0],t[1],t[2],e)}rotateAxisAngleRadObject(t,e){_wl_object_rotate_axis_angle_rad_obj(this.objectId,t[0],t[1],t[2],e)}rotate(t){_wl_object_rotate_quat(this.objectId,t[0],t[1],t[2],t[3])}rotateObject(t){_wl_object_rotate_quat_obj(this.objectId,t[0],t[1],t[2],t[3])}scale(t){_wl_object_scale(this.objectId,t[0],t[1],t[2])}get transformLocal(){return new Float32Array(HEAPF32.buffer,_wl_object_trans_local(this.objectId),8)}set transformLocal(t){this.transformLocal.set(t),this.setDirty()}getTranslationLocal(t){return _wl_object_get_translation_local(this.objectId,a),t[0]=i[0],t[1]=i[1],t[2]=i[2],t}getTranslationWorld(t){return _wl_object_get_translation_world(this.objectId,a),t[0]=i[0],t[1]=i[1],t[2]=i[2],t}setTranslationLocal(t){_wl_object_set_translation_local(this.objectId,t[0],t[1],t[2])}setTranslationWorld(t){_wl_object_set_translation_world(this.objectId,t[0],t[1],t[2])}get transformWorld(){return new Float32Array(HEAPF32.buffer,_wl_object_trans_world(this.objectId),8)}set transformWorld(t){this.transformWorld.set(t),_wl_object_trans_world_to_local(this.objectId)}get scalingLocal(){return new Float32Array(HEAPF32.buffer,_wl_object_scaling_local(this.objectId),3)}set scalingLocal(t){this.scalingLocal.set(t),this.setDirty()}get scalingWorld(){return new Float32Array(HEAPF32.buffer,_wl_object_scaling_world(this.objectId),3)}set scalingWorld(t){this.scalingWorld.set(t),_wl_object_scaling_world_to_local(this.objectId)}get rotationLocal(){return this.transformLocal.subarray(0,4)}get rotationWorld(){return this.transformWorld.subarray(0,4)}set rotationLocal(t){_wl_object_set_rotation_local(this.objectId,t[0],t[1],t[2],t[3])}set rotationWorld(t){_wl_object_set_rotation_world(this.objectId,t[0],t[1],t[2],t[3])}getForward(t){return t[0]=0,t[1]=0,t[2]=-1,this.transformVectorWorld(t),t}getUp(t){return t[0]=0,t[1]=1,t[2]=0,this.transformVectorWorld(t),t}getRight(t){return t[0]=1,t[1]=0,t[2]=0,this.transformVectorWorld(t),t}transformVectorWorld(t,e){return e=e||t,i[0]=e[0],i[1]=e[1],i[2]=e[2],_wl_object_transformVectorWorld(this.objectId,a),t[0]=i[0],t[1]=i[1],t[2]=i[2],t}transformVectorLocal(t,e){return e=e||t,i[0]=e[0],i[1]=e[1],i[2]=e[2],_wl_object_transformVectorLocal(this.objectId,a),t[0]=i[0],t[1]=i[1],t[2]=i[2],t}transformPointWorld(t,e){return e=e||t,i[0]=e[0],i[1]=e[1],i[2]=e[2],_wl_object_transformPointWorld(this.objectId,a),t[0]=i[0],t[1]=i[1],t[2]=i[2],t}transformPointLocal(t,e){return e=e||t,i[0]=e[0],i[1]=e[1],i[2]=e[2],_wl_object_transformPointLocal(this.objectId,a),t[0]=i[0],t[1]=i[1],t[2]=i[2],t}transformVectorInverseWorld(t,e){return e=e||t,i[0]=e[0],i[1]=e[1],i[2]=e[2],_wl_object_transformVectorInverseWorld(this.objectId,a),t[0]=i[0],t[1]=i[1],t[2]=i[2],t}transformVectorInverseLocal(t,e){return e=e||t,i[0]=e[0],i[1]=e[1],i[2]=e[2],_wl_object_transformVectorInverseLocal(this.objectId,a),t[0]=i[0],t[1]=i[1],t[2]=i[2],t}transformPointInverseWorld(t,e){return e=e||t,i[0]=e[0],i[1]=e[1],i[2]=e[2],_wl_object_transformPointInverseWorld(this.objectId,a),t[0]=i[0],t[1]=i[1],t[2]=i[2],t}transformPointInverseLocal(t,e){return e=e||t,i.set(e),_wl_object_transformPointInverseLocal(this.objectId,a),t[0]=i[0],t[1]=i[1],t[2]=i[2],t}toWorldSpaceTransform(t,e){return e=e||t,i.set(e),_wl_object_toWorldSpaceTransform(this.objectId,a),t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t}toLocalSpaceTransform(t,e){let n=this.parent;return n?n.toObjectSpaceTransform(e):(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7]),t}toObjectSpaceTransform(t,e){return e=e||t,i.set(e),_wl_object_toObjectSpaceTransform(this.objectId,a),t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t}lookAt(t,e=[0,1,0]){_wl_object_lookAt(this.objectId,t[0],t[1],t[2],e[0],e[1],e[2])}destroy(){_wl_scene_remove_object(this.objectId),this.objectId=null}setDirty(){_wl_object_set_dirty(this.objectId)}set active(t){let e=this.getComponents();for(let n of e)n.active=t}getComponent(t,e){let n=lengthBytesUTF8(t)+1,r=_malloc(n);stringToUTF8(t,r,n);let o=_wl_get_component_manager_index(r);if(o<0){let l=_wl_get_js_component_index(this.objectId,r,e||0);return _free(r),l<0?null:_WL._components[l]}_free(r);let s=_wl_get_component_id(this.objectId,o,e||0);return d._wrapComponent(t,o,s)}getComponents(t){let e=t?d._typeIndexFor(t):null,n=[],r=Math.floor(b/3*2),o=_wl_object_get_components(this.objectId,a,r),s=2*o;_wl_object_get_component_types(this.objectId,a+s,r);let l=d._typeIndexFor("js");for(let c=0;c<o;++c){let u=gt[c+s],f=M[c];if(u==l){let y=_WL._components[_wl_get_js_component_index_for_id(f)];(e===null||y.type==t)&&n.push(y);continue}if(e===null){let y=d._typeNameFor(u);n.push(d._wrapComponent(y,u,f))}else u==e&&n.push(d._wrapComponent(t,e,f))}return n}addComponent(t,e){let n=d._typeIndexFor(t),r=null,o=null;if(n<0){if(!(t in _WL._componentTypeIndices))throw new TypeError("Unknown component type '"+t+"'");let s=_wl_object_add_js_component(this.objectId,_WL._componentTypeIndices[t]);o=_wl_get_js_component_index_for_id(s),r=_WL._components[o]}else{let s=_wl_object_add_component(this.objectId,n);r=d._wrapComponent(t,n,s)}if(e!==void 0)for(let s in e)xt.includes(s)||(r[s]=e[s]);return n<0&&_wljs_component_init(o),(!e||!("active"in e&&!e.active))&&(r.active=!0),r}equals(t){return t?this.objectId==t.objectId:!1}static _typeIndexFor(t){let e=lengthBytesUTF8(t)+1,n=_malloc(e);stringToUTF8(t,n,e);let r=_wl_get_component_manager_index(n);return _free(n),r}static _typeNameFor(t){return UTF8ToString(_wl_component_manager_name(t))}static _wrapComponent(t,e,n){if(n<0)return null;let r=ct[e]||(ct[e]=[]);return t=="collision"?r[n]||(r[n]=new O(e,n)):t=="text"?r[n]||(r[n]=new Z(e,n)):t=="view"?r[n]||(r[n]=new G(e,n)):t=="mesh"?r[n]||(r[n]=new q(e,n)):t=="input"?r[n]||(r[n]=new J(e,n)):t=="light"?r[n]||(r[n]=new Y(e,n)):t=="animation"?r[n]||(r[n]=new Q(e,n)):t=="physx"?r[n]||(r[n]=new H(e,n)):r[n]||(r[n]=new g(e,n))}static _wrapObject(t){let e=ht[t]||(ht[t]=new d(t));return e.objectId=t,e}},V=class{constructor(t){this._index=t}get jointCount(){return _wl_skin_get_joint_count(this._index)}get jointIds(){return new Uint16Array(HEAPU16.buffer,_wl_skin_joint_ids(this._index),this.jointCount)}get inverseBindTransforms(){return new Float32Array(HEAPF32.buffer,_wl_skin_inverse_bind_transforms(this._index),8*this.jointCount)}get inverseBindScalings(){return new Float32Array(HEAPF32.buffer,_wl_skin_inverse_bind_scalings(this._index),3*this.jointCount)}};import{vec3 as et,quat as It}from"gl-matrix";var nt=null,B=null,rt=null,h=class extends Lt{constructor(e,n,r,o){var u,f,y,it;o=lt({pointerStyleHandler:m=>{I.style.cursor=m},preventBleeding:!0},o);super(r,o);this.texture=null;this.mesh=null;this.oldTexSize=[0,0];this.collision=null;this.cursorTarget=null;this.valid=!1;this.keydownEventListener=null;this.keyupEventListener=null;this.unHoverFunction=null;this.moveFunction=null;this.downFunction=null;this.upFunction=null;let s=(u=o.collisionGroup)!=null?u:1,l=(f=o.registerPointerDriver)!=null?f:!0,c=(y=o.registerKeyboardDriver)!=null?y:!0;if(this.unitsPerPixel=(it=o.unitsPerPixel)!=null?it:.01,this.meshObject=bt.addObject(e),this.meshObject.active=!1,s!==null&&l&&this.registerDriver(h.pointerDriver),c&&this.registerDriver(h.keyboardDriver),this.meshComponent=this.meshObject.addComponent("mesh"),this.materialClone=n.clone(),this.meshComponent.material=this.materialClone,this._setupMesh(1,0),s!==null){this.collision=this.meshObject.addComponent("collision",{collider:pt.Box,extents:[1,1,.01],group:1<<s}),this.cursorTarget=this.meshObject.addComponent("cursor-target");let m=new Float32Array(3),ot=new Float32Array(3),st=new Float32Array(4),K=this.meshObject,X=C=>(m.set(C.rayHit.locations[0]),K.getTranslationWorld(ot),et.sub(m,m,ot),It.invert(st,K.rotationWorld),et.transformQuat(m,m,st),et.div(m,m,K.scalingWorld),[Math.min(Math.max((m[0]+1)/2,0),1),Math.min(Math.max(1-(m[1]+1)/2,0),1)]);if(l){let C=!1,D=!1,P=!1;this.keydownEventListener=p=>{p.key==="Shift"&&(C=!0),p.key==="Control"&&(D=!0),p.key==="Alt"&&(P=!0)},this.keyupEventListener=p=>{p.key==="Shift"&&(C=!1),p.key==="Control"&&(D=!1),p.key==="Alt"&&(P=!1)},I.addEventListener("keydown",this.keydownEventListener),I.addEventListener("keyup",this.keyupEventListener),this.unHoverFunction=(p,w)=>{h.pointerDriver.leavePointer(this,h.getPointerID(w))},this.moveFunction=(p,w)=>{h.pointerDriver.movePointer(this,h.getPointerID(w),...X(w),null,C,D,P)},this.downFunction=(p,w)=>{h.pointerDriver.movePointer(this,h.getPointerID(w),...X(w),1,C,D,P)},this.upFunction=(p,w)=>{h.pointerDriver.movePointer(this,h.getPointerID(w),...X(w),0,C,D,P)},this.cursorTarget.addUnHoverFunction(this.unHoverFunction),this.cursorTarget.addMoveFunction(this.moveFunction),this.cursorTarget.addDownFunction(this.downFunction),this.cursorTarget.addUpFunction(this.upFunction)}}this.valid=!0,this.maxCanvasWidth=2048,this.maxCanvasHeight=2048}static get pointerDriver(){return nt===null&&(nt=new Ft),nt}static get keyboardDriver(){return B===null&&(B=new Tt,B.bindDOMElem(I)),B}static get pointerIDs(){return rt===null&&(rt=new Map),rt}static getPointerID(e){let n=h.pointerIDs,r=n.get(e);return typeof r=="undefined"&&(r=h.pointerDriver.registerPointer(),n.set(e,r)),r}update(){if(!this.valid)return;let e=this.meshObject;this.preLayoutUpdate();let n=this.resolveLayout(),[r,o]=this.canvasDimensions;if(n){let[l,c]=this.dimensions,[u,f]=this.effectiveScale;e.resetScaling(),e.scale([this.unitsPerPixel*l,this.unitsPerPixel*c,.01]),this.collision!==null&&(this.collision.extents=[e.scalingWorld[0],e.scalingWorld[1],.01]),this._setupMesh(u*l/r,1-f*c/o)}this.postLayoutUpdate();let s=this.paint();if(e.active=this.enabled,!!s)if(this.oldTexSize[0]!==r||this.oldTexSize[1]!==o){this.oldTexSize[0]=r,this.oldTexSize[1]=o;let l=this.materialClone,c=this.texture;this.texture=new T(this.canvas),l.shader==="Flat Opaque Textured"||l.shader==="Flat Transparent Textured"?l.flatTexture=this.texture:l.shader=="Phong Opaque Textured"?l.diffuseTexture=this.texture:console.error("Shader",l.shader,"not supported by WLRoot"),c&&c.destroy()}else this.texture?this.texture.update():console.warn("There is no texture to update! Is the canvas dimensionless?")}_setVertex(e,n,r,o,s,l,c,u,f,y){e.set([r,o,s,f,y,l,c,u],n*x.VERTEX_FLOAT_SIZE)}_setUV(e,n,r,o){e.set([r,o],n*x.VERTEX_FLOAT_SIZE+x.TEXCOORD.U)}_setupMesh(e,n){let r=new Uint8Array([0,3,1,0,2,3]),o=new Float32Array(4*x.VERTEX_FLOAT_SIZE);this._setVertex(o,0,-1,1,0,0,0,1,0,1),this._setVertex(o,1,1,1,0,0,0,1,e,1),this._setVertex(o,2,-1,-1,0,0,0,1,0,n),this._setVertex(o,3,1,-1,0,0,0,1,e,n);let s=new x({indexData:r,indexType:j.UnsignedByte,vertexData:o,vertexCount:4});this.meshComponent.mesh=s,this.mesh&&this.mesh.destroy(),this.mesh=s}destroy(){this.keydownEventListener!==null&&(I.removeEventListener("keydown",this.keydownEventListener),this.keydownEventListener=null),this.keyupEventListener!==null&&(I.removeEventListener("keyup",this.keyupEventListener),this.keyupEventListener=null),this.cursorTarget&&(this.unHoverFunction!==null&&(this.cursorTarget.removeUnHoverFunction(this.unHoverFunction),this.unHoverFunction=null),this.moveFunction!==null&&(this.cursorTarget.removeMoveFunction(this.moveFunction),this.moveFunction=null),this.downFunction!==null&&(this.cursorTarget.removeDownFunction(this.downFunction),this.downFunction=null),this.upFunction!==null&&(this.cursorTarget.removeUpFunction(this.upFunction),this.upFunction=null)),this.texture&&(this.texture.destroy(),this.texture=null),this.collision&&(this.collision.destroy(),this.collision=null),this.cursorTarget&&(this.cursorTarget.destroy(),this.cursorTarget=null),this.meshComponent&&(this.meshComponent.destroy(),this.meshComponent=null),this.mesh&&this.mesh.destroy(),this.meshObject&&(this.meshObject.destroy(),this.meshObject=null),this.valid=!1,super.destroy()}};import{VirtualKeyboard as Wt,defaultVirtualKeyboardTemplate as Et,Margin as At}from"@rafern/canvas-ui";var N=class extends h{constructor(e,n,r){var s,l;let o=(s=r==null?void 0:r.keyboardDriver)!=null?s:h.keyboardDriver;super(e,n,new At(new Wt(o,(l=r==null?void 0:r.keyboardTemplate)!=null?l:Et)),r);this.keyboardDriver=o}updateVisibility(){!this.valid||(this.enabled=this.keyboardDriver.needsInput)}};import{PointerHint as kt}from"@rafern/canvas-ui";R("canvas-ui-input-guard",{keyboardComponentName:{type:v.String,default:""},keyboardObject:{type:v.Object,default:null},pointerComponentName:{type:v.String,default:""},pointerObject:{type:v.Object,default:null},cursorObject:{type:v.Object,default:null}},{init(){this.pointer=null,this.pointerComponent=null,this.keyboardComponent=null},start(){if(this.keyboardComponentName!=="")if(this.keyboardObject!==null){let _=this.keyboardObject.getComponent(this.keyboardComponentName,0);_===null?console.warn("keyboardObject has no component with name",this.keyboardComponentName):this.keyboardComponent=_}else console.warn("keyboardComponentName set in canvas-ui-keyboard-guard, but keyboardObject was not");if(this.pointerComponentName!=="")if(this.pointerObject!==null){let _=this.pointerObject.getComponent(this.pointerComponentName,0);if(_===null){console.warn("pointerObject has no component with name",this.pointerComponentName);return}if(this.cursorObject!==null){let t=this.cursorObject.getComponent("cursor",0);t===null?console.warn("cursorObject set in canvas-ui-keyboard-guard, but cursorObject has no cursor component"):(this.pointer=h.getPointerID(t),this.pointerComponent=_)}else console.warn("pointerObject set in canvas-ui-keyboard-guard, but cursorObject was not")}else console.warn("pointerComponentName set in canvas-ui-keyboard-guard, but pointerObject was not")},update(_){if(this.keyboardComponent!==null){let t=!h.keyboardDriver.needsInput;this.keyboardComponent.active=t}if(this.pointer!==null&&this.pointerComponent!==null){let t=h.pointerDriver.getPointerHint(this.pointer)===kt.None;this.pointerComponent.active=t}},onDeactivate(){this.keyboardComponent!==null&&(this.keyboardComponent.active=!0),this.pointerComponent!==null&&(this.pointerComponent.active=!0)}});R("virtual-keyboard-ui-root",{material:{type:v.Material}},{init(){this.root=new N(this.object,this.material),this.forceDisabled=!1},update(_){this.root&&!this.forceDisabled&&(this.root.updateVisibility(),this.root.update())},onActivate(){this.root&&(this.forceDisabled=!1,this.root.enabled=!0)},onDeactivate(){this.root&&(this.forceDisabled=!0,this.root.enabled=!1)}});export{h as WLRoot,N as WLVirtualKeyboardRoot};
//# sourceMappingURL=index.esm.js.map
