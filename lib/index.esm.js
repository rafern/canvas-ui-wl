import{Root as j,PointerDriver as x,DOMKeyboardDriver as D,Theme as C}from"canvas-ui";import{vec3 as g}from"gl-matrix";var f=null,m=null,y=null,t=class extends j{static get pointerDriver(){return f===null&&(f=new x),f}static get keyboardDriver(){return m===null&&(m=new D,m.bindDOMElem(WL.canvas)),m}static get pointerIDs(){return y===null&&(y=new Map),y}static getPointerID(e){let r=t.pointerIDs,i=r.get(e);return typeof i=="undefined"&&(i=t.pointerDriver.registerPointer(),r.set(e,i)),i}constructor(e,r,i,o=new C,n=.01,s=1,u=!0,p=!0){super(i,c=>{WL.canvas.style.cursor=c},o);if(this.unitsPerPixel=n,this.meshObject=WL.scene.addObject(e),this.meshObject.active=!1,s!==null&&u&&this.registerDriver(t.pointerDriver),p&&this.registerDriver(t.keyboardDriver),this.mesh=this.meshObject.addComponent("mesh"),this.materialClone=r.clone(),this.mesh.material=this.materialClone,this.oldTexSize=[0,0],this._setupMesh(1,0),s!==null){this.collision=this.meshObject.addComponent("collision",{collider:WL.Collider.Box,extents:[1,1,.01],group:1<<s});let c=this.meshObject.addComponent("cursor-target"),l=new Float32Array(3),O=new Float32Array(3),b=d=>(l.set(d.rayHit.locations[0]),this.meshObject.getTranslationWorld(O),g.sub(l,l,O),g.div(l,l,this.meshObject.scalingLocal),[Math.min(Math.max((l[0]+1)/2,0),1),Math.min(Math.max(1-(l[1]+1)/2,0),1)]);u&&(c.addUnHoverFunction((d,a)=>{t.pointerDriver.leavePointer(this,t.getPointerID(a))}),c.addCursorMoveFunction((d,a)=>{t.pointerDriver.movePointer(this,t.getPointerID(a),...b(a))}),c.addCursorDownFunction((d,a)=>{t.pointerDriver.movePointer(this,t.getPointerID(a),...b(a),!0)}),c.addCursorUpFunction((d,a)=>{t.pointerDriver.movePointer(this,t.getPointerID(a),...b(a),!1)}))}else this.collision=null;this.valid=!0}update(){if(!this.valid)return;this.preLayoutUpdate();let e=this.resolveLayout(),[r,i]=this.canvasDimensions;if(e){let[n,s]=this.dimensions;this.meshObject.resetScaling(),this.meshObject.scale([this.unitsPerPixel*n,this.unitsPerPixel*s,.01]),this.collision!==null&&(this.collision.extents=[this.meshObject.scalingLocal[0],this.meshObject.scalingLocal[1],.01]),this._setupMesh(n/r,1-s/i)}this.postLayoutUpdate();let o=this.paint();if(this.meshObject.active=this.enabled,!!o)if(this.oldTexSize[0]!==r||this.oldTexSize[1]!==i){this.oldTexSize[0]=r,this.oldTexSize[1]=i;let n=this.materialClone;this.texture=new WL.Texture(this.canvas),n.shader==="Flat Opaque Textured"||n.shader==="Flat Transparent Textured"?n.flatTexture=this.texture:n.shader=="Phong Opaque Textured"?n.diffuseTexture=this.texture:console.error("Shader",n.shader,"not supported by WLRoot")}else this.texture.update()}_setVertex(e,r,i,o,n,s,u,p,c,l){e.set([i,o,n,c,l,s,u,p],r*WL.Mesh.VERTEX_FLOAT_SIZE)}_setUV(e,r,i,o){e.set([i,o],r*WL.Mesh.VERTEX_FLOAT_SIZE+WL.Mesh.TEXCOORD.U)}_setupMesh(e,r){let i=new Uint8Array([0,3,1,0,2,3]),o=new Float32Array(4*WL.Mesh.VERTEX_FLOAT_SIZE);this._setVertex(o,0,-1,1,0,0,0,1,0,1),this._setVertex(o,1,1,1,0,0,0,1,e,1),this._setVertex(o,2,-1,-1,0,0,0,1,0,r),this._setVertex(o,3,1,-1,0,0,0,1,e,r),this.mesh.mesh=new WL.Mesh({indexData:i,indexType:WL.MeshIndexType.UnsignedByte,vertexData:o})}};import{VirtualKeyboard as T,defaultVirtualKeyboardTemplate as w,Theme as k,Margin as L}from"canvas-ui";var v=class extends t{constructor(e,r,i=w,o=null,n=new k,s=.01,u=1,p=!0){o===null&&(o=t.keyboardDriver),super(e,r,new L(new T(o,i)),n,s,u,p,!1),this.keyboardDriver=o}updateVisibility(){!this.valid||(this.enabled=this.keyboardDriver.getFocusedRoot()!==null)}};import{PointerHint as P}from"canvas-ui";WL.registerComponent("canvas-ui-input-guard",{keyboardComponentName:{type:WL.Type.String,default:""},keyboardObject:{type:WL.Type.Object,default:null},pointerComponentName:{type:WL.Type.String,default:""},pointerObject:{type:WL.Type.Object,default:null},cursorObject:{type:WL.Type.Object,default:null}},{init(){this.pointer=null,this.pointerComponent=null,this.keyboardComponent=null},start(){if(this.keyboardComponentName!=="")if(this.keyboardObject!==null){let h=this.keyboardObject.getComponent(this.keyboardComponentName);h===null?console.warn("keyboardObject has no component with name",this.keyboardComponentName):this.keyboardComponent=h}else console.warn("keyboardComponentName set in canvas-ui-keyboard-guard, but keyboardObject was not");if(this.pointerComponentName!=="")if(this.pointerObject!==null){let h=this.pointerObject.getComponent(this.pointerComponentName);if(h===null){console.warn("pointerObject has no component with name",this.pointerComponentName);return}if(this.cursorObject!==null){let e=this.cursorObject.getComponent("cursor");e===null?console.warn("cursorObject set in canvas-ui-keyboard-guard, but cursorObject has no cursor component"):(this.pointer=t.getPointerID(e),this.pointerComponent=h)}else console.warn("pointerObject set in canvas-ui-keyboard-guard, but cursorObject was not")}else console.warn("pointerComponentName set in canvas-ui-keyboard-guard, but pointerObject was not")},update(h){if(this.keyboardObject!==null){let e=t.keyboardDriver.getFocusedRoot()===null;this.keyboardObject.active=e}if(this.pointer!==null){let e=t.pointerDriver.getPointerHint(this.pointer)===P.None;this.pointerObject.active=e}},onDeactivate(){this.keyboardObject!==null&&(this.keyboardObject.active=!0),this.pointerObject!==null&&(this.pointerObject.active=!0)}});WL.registerComponent("virtual-keyboard-ui-root",{material:{type:WL.Type.Material}},{init(){this.root=new v(this.object,this.material),this.forceDisabled=!1},update(h){this.root&&!this.forceDisabled&&(this.root.updateVisibility(),this.root.update())},onActivate(){this.root&&(this.forceDisabled=!1,this.root.enabled=!0)},onDeactivate(){this.root&&(this.forceDisabled=!0,this.root.enabled=!1)}});export{t as WLRoot,v as WLVirtualKeyboardRoot};
//# sourceMappingURL=index.esm.js.map
